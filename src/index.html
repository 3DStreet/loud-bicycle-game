<html>
  <head>
    <title>Loud Bicycle Game</title>
    <style>
      body {
        font-family: Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;
        color: white
        -webkit-touch-callout:none;
        -webkit-user-select:none;
        -khtml-user-select:none;
        -moz-user-select:none;
        -ms-user-select:none;
        user-select:none;
        -webkit-tap-highlight-color:rgba(0,0,0,0);
      }

      #shout, #horn, #ray {
        position: absolute;
        top: 0;
        height: 150px;
        width: 150px;
        border: 2px solid green;
        user-drag: none;
        -webkit-user-drag: none;
        user-select: none;
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
        -webkit-touch-callout:none;
      }

      #shout > img, #horn > img, #ray > img {
        pointer-events: none;
        width: 100%;
        height: 100%;
      }

      #horn.disabled {
        border: 2px solid red;
      }
      #shout.disabled {
        border: 2px solid red;
      }
      #special-meter, #main-meter, #ray-meter {
        position: absolute;
        top: 200px;
        width: 150px;
      }
      .high-meter {
        accent-color: green;
      }
      .low-meter {
        accent-color: coral;
      }

      #ray, #ray-meter {
        left: 300px;
      }

      #horn, #main-meter {
        left: 150px;
      }

      #life-indicator-container {
        position: absolute;
        left: 5;
        bottom: 5;
      }

      .life-indicator {
        --c: rgb(224, 57, 57);
        width: 40px;
        aspect-ratio: 1;
        background:
        radial-gradient(at 70% 31%,var(--c) 29%,#0000 30%),
        radial-gradient(at 30% 31%,var(--c) 29%,#0000 30%),
        conic-gradient(from -45deg at 50% 84%,var(--c) 90deg,#0000 0) 
          bottom/100% 50% no-repeat;

      }

      #score-container {
        position: absolute;
        right: 5;
        bottom: 5;
      }

      #score {
        font-size: 50px;
      }

      #game-menu {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      #game-menu > * {
        pointer-events: all;
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        width: 100%;
        height: 100%;
      }

      #game-menu-bg {
        background-color: #5c698b;
        opacity: 1;
        width: 100%;
        height: 100%;
        transition: opacity 1s;
        pointer-events: none;
      }

      #landing {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 25px;
        font-weight: 700;
        transition: opacity 0.4s linear;
      }

      #landing img {
        flex-grow: 1;
        width: 400px;
        max-width: 60%;
        animation: float 6s ease-in-out infinite;
      }

      #main-menu {
        opacity: 0;
        transition: opacity 0.4s linear;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
      }

      #credits {
        flex-direction: column;
      }

      #settings {
        flex-direction: column;
      }

      #level-selection {
        flex-direction: column;
        gap: 15px;
      }

      #level-button-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        width: 80%;
        gap: 10px;
      }

      #level-end-container {
        color: black;
        background-color: aliceblue;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        width: 40%;
        height: 300px;
        border-radius: 10px;
        gap: 10px;
      }


      .disabled {
        pointer-events: none !important;
        opacity: 0;
      }

      .enabled {
        pointer-events: all;
        opacity: 1 !important;
      }


      @keyframes float {
        0% {
          transform: translatey(0px);
        }
        50% {
          transform: translatey(-20px);
        }
        100% {
          transform: translatey(0px);
        }
      }

      .btn {
        align-items: center;
        background-image: linear-gradient(135deg, #ff6c36 40%, #fc894d);
        border: 0;
        border-radius: 10px;
        box-sizing: border-box;
        color: #fff;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        font-family: "Codec cold",sans-serif;
        font-size: 16px;
        font-weight: 700;
        height: 54px;
        width: 100px;
        justify-content: center;
        letter-spacing: .4px;
        line-height: 1;
        max-width: 100%;
        padding-left: 20px;
        padding-right: 20px;
        padding-top: 3px;
        text-decoration: none;
        text-transform: uppercase;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .btn:active {
        outline: 0;
      }

      .btn:hover {
        outline: 0;
      }

      .btn span {
        transition: all 200ms;
      }

      .btn:hover span {
        transform: scale(.9);
        opacity: .75;
      }

      @media screen and (max-width: 991px) {
        #main-menu {
          flex-direction: column;
        }

        .btn {
          font-size: 13px;
          height: 50px;
        }

        .btn span {
          line-height: 50px;
        }
      }
    </style>
  </head>
  <body>
    <a-scene
      keyboard-shortcuts="enterVR: false"
      fog="type: linear; color: #AAA; far: 100"
      renderer="gammaOutput: true"
      vr-mode-ui="enabled: false" 
      ar-mode-ui="enabled: false" 
      pool__interactable="container: #level; mixin: interactable-mixin; size: 10" 
      pool__bikes="container: #level; mixin: bike-pool-mixin; size: 6" 
      pool__smogs="container: #level; mixin: smog-mixin; size: 20" 
      gltf-model="dracoDecoderPath: https://www.gstatic.com/draco/versioned/decoders/1.4.3/; meshoptDecoderPath: https://unpkg.com/meshoptimizer@0.16.0/meshopt_decoder.js;">
      <a-assets>
        <streetmix-assets url="./3dstreet-assets/"></streetmix-assets>
        <audio id="muffled-voice" src="./assets/tires.mp3" preload="auto"></audio>
        <audio id="win-sound" src="./assets/win.webm" preload="auto"></audio>
        <audio id="ambient-sound" src="./assets/ambience.webm" preload="auto"></audio>
        <img id="comic-effect" src="./assets/comic_effect.png">
        <img id="grass-floor" src="./3dstreet-assets/materials/TexturesCom_Grass0052_1_seamless_S.jpg">
        <img id="sky" src="https://github.3dstreet.org/assets/CGSkies_0343_doubled_2048.jpg">
        <a-mixin id="interactable-mixin" interactable  sound="src:#muffled-voice" material="color: red" color="#4CC3D9"></a-mixin>
        <a-mixin id="smog-mixin" smog geometry="primitive: box; width: 1; height: 1; depth: 0.2"></a-mixin>
        <a-mixin id="bike-pool-mixin" gltf-model="#cyclist-kid-asset" animation-mixer bike-train-member></a-mixin>
        <a-asset-item id="wave" src="./assets/wave.glb"></a-asset-item>
        <!-- <a-asset-item id="car" src="./assets/car.glb"></a-asset-item> -->
        <a-asset-item id="bell" src="./assets/bell.glb"></a-asset-item>

        <!-- loud bicycle pack -->
        <a-asset-item id="cyclist-cargo-asset" src="//assets.3dstreet.app/sets/cargo-bike-animation/gltf-exports/meshopt/cargo_bike_animation_v1.glb"></a-asset-item>
        <a-asset-item id="cyclist1-asset" src="//assets.3dstreet.app/sets/cyclist-animation/gltf-exports/meshopt/cyclist-1-animation-v1.glb"></a-asset-item>
        <a-asset-item id="cyclist2-asset" src="//assets.3dstreet.app/sets/cyclist-animation/gltf-exports/meshopt/cyclist-2-animation-v1.glb"></a-asset-item>
        <a-asset-item id="cyclist3-asset" src="//assets.3dstreet.app/sets/cyclist-animation/gltf-exports/meshopt/cyclist-3-animation-v1.glb"></a-asset-item>
        <a-asset-item id="cyclist-kid-asset" src="//assets.3dstreet.app/sets/cyclist-animation/gltf-exports/meshopt/Kid_cyclist_animation_v01.glb"></a-asset-item>
        <a-asset-item id="cyclist-dutch-asset" src="//assets.3dstreet.app/sets/cyclist-animation/gltf-exports/meshopt/Dutch_cyclist_animation_v01.glb"></a-asset-item>
        <a-asset-item id="loud-bicycle-mini-asset" src="//assets.3dstreet.app/sets/cycle-horn/gltf-exports/meshopt/loud-bicycle-mini-horn.glb"></a-asset-item>
        <a-asset-item id="loud-bicycle-classic-asset" src="//assets.3dstreet.app/sets/cycle-horn/gltf-exports/meshopt/loud-bicycle-classic-horn.glb"></a-asset-item>
        <a-asset-item id="building-school-asset" src="//assets.3dstreet.app/sets/school-building/gltf-exports/meshopt/school-building.glb"></a-asset-item>
        <a-asset-item id="building-bar-asset" src="//assets.3dstreet.app/sets/irish-bar-building/gltf-exports/meshopt/irish-bar-building.glb"></a-asset-item>
        <a-asset-item id="vehicle-bmw-m2-asset" src="//assets.3dstreet.app/sets/vehicles-rig/meshopt/BMW_m2-rig.glb"></a-asset-item>
        <a-asset-item id="prop-suburban-houses-asset" src="//assets.3dstreet.app/objects/suburbia/suburban-houses.glb"></a-asset-item>
        <a-asset-item id="prop-banner-wfh-asset" src="//assets.3dstreet.app/sets/wfh-banner/gltf-exports/meshopt/wfh-banner.glb"></a-asset-item>
        <a-asset-item id="prop-raygun-asset" src="//assets.3dstreet.app/sets/ray-gun/gltf-exports/meshopt/rayGun.glb"></a-asset-item>
        <a-mixin id="cyclist-cargo" gltf-model="#cyclist-cargo-asset"></a-mixin>
        <a-mixin id="cyclist1" gltf-model="#cyclist1-asset"></a-mixin>
        <a-mixin id="cyclist2" gltf-model="#cyclist2-asset"></a-mixin>
        <a-mixin id="cyclist3" gltf-model="#cyclist3-asset"></a-mixin>
        <a-mixin id="cyclist-kid" gltf-model="#cyclist-kid-asset"></a-mixin>
        <a-mixin id="cyclist-dutch" gltf-model="#cyclist-dutch-asset"></a-mixin>
        <a-mixin id="loud-bicycle-mini" gltf-model="#loud-bicycle-mini-asset"></a-mixin>
        <a-mixin id="loud-bicycle-classic" gltf-model="#loud-bicycle-classic-asset"></a-mixin>
        <a-mixin id="building-school" gltf-model="#building-school-asset"></a-mixin>
        <a-mixin id="building-bar" gltf-model="#building-bar-asset"></a-mixin>
        <a-mixin id="vehicle-bmw-m2" gltf-model="#vehicle-bmw-m2-asset"></a-mixin>
        <a-mixin id="prop-suburban-houses" gltf-model="#prop-suburban-houses-asset"></a-mixin>
        <a-mixin id="prop-banner-wfh" gltf-model="#prop-banner-wfh-asset"></a-mixin>

      </a-assets>
      <a-entity id="ambient-audio" sound="src: #ambient-sound; autoplay: false; loop: true; volume: 0.5"></a-entity>
      <a-entity id="ambient-light" light="type: ambient; color: #222"></a-entity>
      <a-entity id="directional-light" light="type: directional; color: #444; intensity: 0.6" position="-0.5 1 1"></a-entity>
      <a-sky src="#sky"></a-sky>
      <a-camera position="0 5 3" rotation="-35 0 0" wasd-controls-enabled="false" look-controls-enabled="false" fov="90"></a-camera>
      <a-entity
        id="model"
        geometry="primitive: box; depth: 1.5; width: 0.6"
        material="visible: false;"
        sound="src: url(./assets/ES_Human Voice Clip 200 - SFX Producer.wav);"
        player-controller="speed: 2.0"
        aabb-collider="objects:[interactable], [smog]"
      >
        <a-entity id="spot-light" light="type: spot; angle: 15.97; color: #f5f0e5; penumbra: 0.54; decay: 0.23; distance: 25.35; intensity: 1.47" position="0 1 -0.40039" rotation="-19.74 0 0"></a-entity>
        <!-- <a-entity id="back-light" geometry="primitive: plane; height: 0.02; width: 0.06" material="shader: flat; color: red" position="-0.02, 0.949 0.432"></a-entity> -->
        <a-entity id="player-cyclist" mixin="cyclist1" animation-mixer rotation="0 180 0"></a-entity>
        <a-entity id="noise-indicator" gltf-model="#wave" visible="false" noise-indicator position="0 0.5 0">
          <a-sphere id="noise-indicator-collider" visible="false" aabb-collider="objects:[interactable], [bike-train-member]"></a-sphere>
        </a-entity>
      </a-entity>
      <a-entity id="bell-indicator" gltf-model="#bell" visible="false" scale="0.75 0.75 0.75"></a-entity>
      <a-entity id="flash-light" light="type: point; color: #f2ad13; decay: 0.23; distance: 25.35; intensity: 0.0" animation="property: light.intensity; from: 0.0; to: 80.0; dur: 400; dir: alternate; loop: 1; startEvents: startAnimation" position="0 1 -0.40039" rotation="-19.74 0 0"></a-entity>

      <a-entity id="interactable-spawner" interactable-pool></a-entity>
      <a-entity id="smog-spawner" smog-pool></a-entity>
      <a-entity id="bike-train-spawner" bike-train-pool></a-entity>

      <a-entity id="game-manager" game-manager sound="src: url(./assets/breath_caugh.webm);"></a-entity>
      <a-entity noise-meter="clickerId:shout; meterId:special-meter; isSmall:true; keyCode:q;" sound="src: url(./assets/bell.webm);"></a-entity>
      <a-entity id="horn-noise" noise-meter="clickerId:horn; meterId:main-meter; isSmall:false; keyCode:w" sound="src: url(./assets/shout.webm); loop: true"></a-entity>
      <a-entity id="ray-noise" noise-meter="clickerId:ray; meterId:ray-meter; keyCode:e; lightId: flash-light" sound="src: url(./assets/raygun.wav);"></a-entity>

      <a-entity id="level" animation="property: position; to: 0 0 400; autoplay: false; dur: 100000; easing: linear; loop: false">
        <a-plane src="#grass-floor" height="1000" width="1000" rotation="-90 0 0" position="0 -0.05 0" material="repeat: 20 20"></a-plane>
      </a-entity>

    </a-scene>

<!-- special weapon, bell-->
    <div id="shout">
      <img height="200" width="200" src="./assets/bell.jpg" >
    </div>
    <progress id="special-meter" class="high-meter" value="0" max="100"></progress>

  <!-- Raygun -->
    <div id="ray">
      <img style="display: none" height="200" width="200" src="./assets/gun-ray.png" >
    </div>
    <progress id="ray-meter" style="display: none" class="high-meter" value="0" max="100"></progress>

<!-- main weapon, shout, Loud Classic, Loud Mini -->
    <div id="horn">
      <img height="200" width="200" src="./assets/shout.jpg" >
    </div>
    <progress id="main-meter" class="high-meter" value="0" max="100"></progress>

    <div id="game-menu">
      <div id="game-menu-bg">
      </div>
      <div id="landing">
        <img src="./assets/logo__loud-bicycle.svg" alt="Loud Bicycle Logo">
        <p id="landing-label">Loading</p>
      </div>
      <div id="main-menu" class="disabled">
        <button class="btn" onclick="setLevelSelectionEnabled(true)"><span class="text">Play</span></button>
        <button class="btn" onclick="setSettingsEnabled(true)"><span class="text">Settings</span></button>
        <button class="btn" onclick="setCreditsEnabled(true)"><span class="text">Credits</span></button>
      </div>
      <div id="level-end-screen" class="disabled">
        <div id="level-end-container">
          <h3 id="level-end-header"></h3>
          <p>Data tbd</p>
          <button id="level-end-continue" class="btn" onclick="setEndScreenEnabled(false); setMenuEnabled(false)"><span class="text">Continue</span></button>
        </div>
      </div>
      <div id="level-selection" class="disabled">
        <div id="level-button-container">
          <button id="level-1-button" class="btn"><span class="text">Level 1</span></button>
          <button id="level-2-button" class="btn"><span class="text">Level 2</span></button>
          <button id="level-3-button" class="btn"><span class="text">Level 3</span></button>
          <button id="level-4-button" class="btn"><span class="text">Level 4</span></button>
        </div>
        <button class="btn" onclick="setLevelSelectionEnabled(false); setMenuEnabled(true)"><span class="text">Back</span></button>
      </div>
      <div id="pause-menu" class="disabled">
        <div id="pause-menu-container">
          <button id="continue" class="btn"><span class="text">Continue</span></button>
          <button id="quit" class="btn"><span class="text">Quit</span></button>
        </div>
      </div>
      <div id="credits" class="disabled">
        <p>
          A game by Loud Bicycle
        </p>
        <h5>
          Developed by
        </h5>
        <p>
          Jonathan Lansey
        </p>
        <p>
          Kieran Farr
        </p>
        <p>
          Florian Isikci
        </p>
        <button class="btn" onclick="setCreditsEnabled(false)"><span class="text">Back</span></button>
      </div>
      <div id="settings" class="disabled">
        <div>
          <input type="range" id="volume" name="volume" value="1"
                 min="0" max="1" step="0.01" onchange="setGlobalVolume(this.value)">
          <label for="volume">Volume</label>
        </div>
        <button class="btn" onclick="setSettingsEnabled(false)"><span class="text">Back</span></button>
      </div>
    </div>

    <div id="life-indicator-container">
      <div class="life-indicator"></div>
      <div class="life-indicator"></div>
      <div class="life-indicator"></div>
    </div>
    <div id="score-container">
      <p id="score">0</p>
    </div>
  </body>
  <script>
    let sceneEl = document.querySelector('a-scene');
    let gameMenu = document.querySelector('#game-menu');
    let landing = document.querySelector('#landing');
    let credits = document.querySelector('#credits');
    let mainMenu = document.querySelector('#main-menu');
    let endScreen = document.querySelector('#level-end-screen');
    let settings = document.querySelector('#settings');
    let levelSelection = document.querySelector('#level-selection');
    let pauseMenu = document.querySelector('#pause-menu');

    sceneEl.addEventListener('loaded', () => {
      document.querySelector('#landing-label').innerText = "Click to continue...";
      if(window.innerWidth <= 600) {
        document.querySelector('a-camera').setAttribute('fov', 110);
      }
    });

    landing.addEventListener('click', () => {
      if(!sceneEl.hasLoaded) return;
      landing.classList.add('disabled');
      mainMenu.classList.remove('disabled');
      mainMenu.classList.add('enabled');
    })

    function setCreditsEnabled(b) {
      if(b) {
        mainMenu.classList.remove('enabled');
        mainMenu.classList.add('disabled');
        credits.classList.add('enabled');
        credits.classList.remove('disabled');
      } else {
        mainMenu.classList.remove('disabled');
        mainMenu.classList.add('enabled');
        credits.classList.remove('enabled');
        credits.classList.add('disabled');
      }
    }

    function setSettingsEnabled(b) {
      if(b) {
        mainMenu.classList.remove('enabled');
        mainMenu.classList.add('disabled');
        settings.classList.add('enabled');
        settings.classList.remove('disabled');
      } else {
        mainMenu.classList.remove('disabled');
        mainMenu.classList.add('enabled');
        settings.classList.remove('enabled');
        settings.classList.add('disabled');
      }
    }

    function setEndScreenEnabled(b, message) {
      setMenuEnabled(true);
      if(b) {
        document.querySelector('#game-menu-bg').style.opacity = 1;
        endScreen.classList.add('enabled');
        endScreen.classList.remove('disabled');
        levelSelection.classList.remove('enabled');
        levelSelection.classList.add('disabled');
        if(message) {
          endScreen.querySelector('#level-end-header').innerText = message;
        }
      } else {
        endScreen.classList.remove('enabled');
        endScreen.classList.add('disabled');
        levelSelection.classList.add('enabled');
        levelSelection.classList.remove('disabled');
      }
    }

    function setPauseEnabled(b) {
      if(b) {
        pauseMenu.classList.add('enabled');
        pauseMenu.classList.remove('disabled');
      } else {
        pauseMenu.classList.remove('enabled');
        pauseMenu.classList.add('disabled');
      }
    }

    function setLevelSelectionEnabled(b) {
      if(b) {
        let hasPlayedBefore = localStorage.getItem("played-loud-bicycle");
        mainMenu.classList.remove('enabled');
        mainMenu.classList.add('disabled');
        if(hasPlayedBefore) {
          levelSelection.classList.add('enabled');
          levelSelection.classList.remove('disabled');
        } else {
          // Set key for loading level selection after playing the first time
          localStorage.setItem("played-loud-bicycle", '1')
          window.gameManager.generateLevel(0);
          window.gameManager.playLevel();
          setMenuEnabled(false);
        }
      } else {
        mainMenu.classList.remove('disabled');
        mainMenu.classList.add('enabled');
        levelSelection.classList.remove('enabled');
        levelSelection.classList.add('disabled');
      }
    }

    let audioVolume = 1.0;

    function setGlobalVolume(amount) {
      sceneEl.audioListener.setMasterVolume(amount)
    }

    function setMenuEnabled(b) {
      landing.classList.add('disabled');
      if(b) {
        mainMenu.classList.remove('disabled');
        mainMenu.style.display = 'flex';
      } else {
        mainMenu.classList.add('disabled');
        mainMenu.style.display = 'none';
      }
    }
  </script>
</html>
